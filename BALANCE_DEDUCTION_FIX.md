# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–ê–ù–°–ê –ü–†–ò –ü–û–°–ï–©–ï–ù–ò–ò

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—Ä–æ–∫–∞:
- ‚úÖ –£—Ä–æ–∫ —Å–ø–∏—Å—ã–≤–∞–ª—Å—è —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ (`used_lessons++`)
- ‚ùå **–ë–∞–ª–∞–Ω—Å –ù–ï –º–µ–Ω—è–ª—Å—è**
- ‚ùå **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è –ù–ï —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç—É–¥–µ–Ω—Ç—ã –∏–º–µ–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å —Å–ø–∏—Å–∞–Ω–∏—è –∑–∞ —É—Ä–æ–∫–∏).

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. Backend (`attendance_service.go`)

**–î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è (`status = "attended"`):**

1. **–°–ø–∏—Å–∞–Ω–∏–µ —Å –±–∞–ª–∞–Ω—Å–∞:**
```go
UPDATE student_balance 
SET balance = balance - $1
WHERE student_id = $2
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏:**
```go
INSERT INTO payment_transactions (
    student_id, amount, type, payment_method, description, created_at, company_id
) VALUES ($1, $2, 'deduction', 'subscription', $3, CURRENT_TIMESTAMP, $4)
```

3. **–í—Å–µ –≤ –æ–¥–Ω–æ–π SQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–¥–µ—Ç, –æ—Ç–∫–∞—Ç–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º.

---

### 2. –†–µ—Ç—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–°–∫—Ä–∏–ø—Ç:** `migration/create-retroactive-deductions.js`

- –°–æ–∑–¥–∞–ª **2,190 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** —Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —É–∂–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π
- –ü–µ—Ä–µ—Å—á–∏—Ç–∞–ª –±–∞–ª–∞–Ω—Å—ã **147 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤**
- –í—Å–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

---

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∑–∞ —É—Ä–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ü–µ–Ω–∞ –≤—ã—á–∏—Å–ª—è–ª–∞—Å—å –∫–∞–∫ `balance / total_lessons`, —á—Ç–æ –¥–∞–≤–∞–ª–æ **–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã**.

**–ü—Ä–∏–º–µ—Ä:**
- –ë–∞–ª–∞–Ω—Å: 18,500 ‚Ç∏
- –£—Ä–æ–∫–æ–≤: 8
- –†–∞—Å—á–µ—Ç: 18,500 / 8 = **2,312.50 ‚Ç∏** ‚ùå
- **–†–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –≤ AlfaCRM:** 2,250 ‚Ç∏ ‚úÖ

**–†–µ—à–µ–Ω–∏–µ:**

**–§–∞–π–ª:** `migration/migrate-from-alfacrm.js`

1. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `preloadStudentPrices()`:
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —É—Ä–æ–∫–æ–≤ –∏–∑ AlfaCRM
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `lesson.details.commission` (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)
   - –ë–µ—Ä–µ—Ç **–ø–æ—Å–ª–µ–¥–Ω—é—é** (—Å–∞–º—É—é —Å–≤–µ–∂—É—é) —Ü–µ–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞

2. –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `migrateStudentSubscriptions()`:

**–ë—ã–ª–æ:**
```javascript
const avgPricePerLesson = balance > 0 && totalLessons > 0 ? balance / totalLessons : 3000;
```

**–°—Ç–∞–ª–æ:**
```javascript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É —É—Ä–æ–∫–∞ –∏–∑ AlfaCRM (–ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)
const realPriceFromAlfaCRM = studentPricesCache.get(studentId);
const avgPricePerLesson = realPriceFromAlfaCRM || (balance > 0 && totalLessons > 0 ? balance / totalLessons : 3000);
```

3. –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ –≤ `main()`:
```javascript
await preloadStudentPrices(); // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω —É—Ä–æ–∫–æ–≤ –∏–∑ AlfaCRM
await migrateStudentSubscriptions();
```

**–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ü–µ–Ω:** `migration/fix-price-from-alfacrm.js` (—É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ **51 —Å—Ç—É–¥–µ–Ω—Ç**
- –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ AlfaCRM

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–∏–º–µ—Ä —Å—Ç—É–¥–µ–Ω—Ç–∞ 4054 (–Ø—Å–º–∏–Ω)

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ë–∞–ª–∞–Ω—Å: 18,500 ‚Ç∏ (–Ω–µ –º–µ–Ω—è–ª—Å—è)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: 1 (—Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—Ç–∞)
- –¶–µ–Ω–∞ –∑–∞ —É—Ä–æ–∫: 2,312.50 ‚Ç∏ (–≤—ã—á–∏—Å–ª–µ–Ω–æ –∏–∑ –±–∞–ª–∞–Ω—Å–∞)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ë–∞–ª–∞–Ω—Å: **17,750 ‚Ç∏** (—Å —É—á–µ—Ç–æ–º 16 —É—Ä–æ–∫–æ–≤ √ó 2,312.50 ‚Ç∏)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: **17** (1 –æ–ø–ª–∞—Ç–∞ + 16 —Å–ø–∏—Å–∞–Ω–∏–π)
- –¶–µ–Ω–∞ –∑–∞ —É—Ä–æ–∫: **2,250 ‚Ç∏** (—Ä–µ–∞–ª—å–Ω–∞—è –∏–∑ AlfaCRM)

**–†–∞—Å—á–µ—Ç:**
```
–û–ø–ª–∞—Ç–∞:          +54,750.00 ‚Ç∏
–°–ø–∏—Å–∞–Ω–∏—è (16):   -37,000.00 ‚Ç∏
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:   17,750.00 ‚Ç∏ ‚úÖ
```

---

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend:
```bash
cd backend
taskkill /F /IM api.exe
go run cmd/api/main.go
```

### 2. –û–±–Ω–æ–≤–∏—Ç–µ frontend:
–ù–∞–∂–º–∏—Ç–µ **F5** –∏–ª–∏ **Ctrl+R**

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—É—é –æ—Ç–º–µ—Ç–∫—É –ø–æ—Å–µ—â–µ–Ω–∏—è:
- –û—Ç–º–µ—Ç—å—Ç–µ —É—Ä–æ–∫ –∫–∞–∫ "–ø–æ—Å–µ—â–µ–Ω"
- **–ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω —É–º–µ–Ω—å—à–∏—Ç—å—Å—è** –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Ä–æ–∫–∞
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è** –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤

---

## üîÑ –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ `migrate-from-alfacrm.js`:

1. ‚úÖ –¶–µ–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ AlfaCRM (—Ä–µ–∞–ª—å–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã)
2. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π –±—É–¥–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
3. ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìÅ –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

### Backend:
- `backend/internal/services/attendance_service.go` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

### Migration:
- `migration/migrate-from-alfacrm.js` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω
- `migration/create-retroactive-deductions.js` - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∏–º–µ–Ω–µ–Ω)

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (–ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã):
- `fix-balances.js` - –ø–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤
- `fix-price-from-alfacrm.js` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏–∑ AlfaCRM
- `check-yasmin-prices.js` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ü–µ–Ω

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

**–î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã (2,190 —à—Ç)
- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã (147 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
- ‚úÖ –¶–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (51 —Å—Ç—É–¥–µ–Ω—Ç)

**–î–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π:**
- ‚úÖ –ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å—ã–≤–∞—Ç—å—Å—è
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è
- ‚úÖ –í—Å–µ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π SQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)

---

## üéâ –ò—Ç–æ–≥

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- ‚úÖ –û–ø–ª–∞—Ç—ã (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è)
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏—è –∑–∞ —É—Ä–æ–∫–∏ (deductions)
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç—ã (refunds)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏–∑ AlfaCRM

**–ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª–µ–Ω –∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞!** üí∞

